<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>饿了么批量新建</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .file-input {
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .excel-data {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .image-names {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .upload-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #ccc;
            text-align: center;
            border-radius: 4px;
        }
        .upload-section.dragover {
            border-color: #4CAF50;
            background-color: #f0f8f0;
        }
        .input-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .input-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-section input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>饿了么批量新建</h1>
        
        <!-- Excel文件选择 -->
        <div class="file-input">
            <input type="file" id="excel-file" accept=".xlsx,.xls" style="display: none;">
            <button onclick="readExcelFile()" style="display: none;">读取Excel文件</button>
            <!-- 添加导出Excel按钮 -->
            <button onclick="exportExcelWithImages()">导出包含图片名称的Excel</button>
        </div>
        
        <!-- 店铺分类名称输入框 -->
        <div class="input-section">
            <label for="store-category-input">店铺分类名称：</label>
            <input type="text" id="store-category-input" placeholder="请输入店铺分类名称（可选）">
        </div>
        
        <!-- 图片上传区域 -->
        <div id="upload-area" class="upload-section">
            <p>拖放文件夹到此处，或</p>
            <label for="image-upload">
                <span style="text-decoration: underline; cursor: pointer;">选择图片文件夹</span>
            </label>
            <input type="file" id="image-upload" style="display: none;" webkitdirectory directory mozdirectory multiple>
        </div>

        <!-- 图片名称显示区域 -->
        <div class="image-names">
            <h3>图片名称列表：</h3>
            <div id="image-names-list"></div>
        </div>
        
        <!-- Excel数据显示区域 -->
        <div class="excel-data">
            <h3>Excel数据：</h3>
            <div id="excel-data-container"></div>
        </div>
    </div>

    <script>
        // 图片名称数组
        let imageNames = [];
        // 保存当前工作簿对象，用于导出
        let currentWorkbook = null;
        let currentSheetName = null;
        
        // 调试信息输出函数
        
        // 初始化上传区域事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 检查XLSX库是否加载成功
            setTimeout(function() {
                if (typeof XLSX === 'undefined') {
                    alert('Excel处理库加载失败，请检查网络连接或刷新页面重试');
                } else {
                    // 自动读取Excel文件
                    autoReadExcelFile();
                }
            }, 2000);
            
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            
            // 拖放事件
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            // 文件选择事件
            imageUpload.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFiles(this.files);
                }
            });
        });
        
        // 处理上传的文件
        function handleFiles(files) {
            imageNames = []; // 清空之前的图片名称
            
            // 过滤出图片文件
            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            
            // 获取图片名称
            imageFiles.forEach(file => {
                imageNames.push(file.name);
            });
            
            // 更新图片名称列表显示
            updateImageNamesList();
            
        }
        
        // 更新图片名称列表显示
        function updateImageNamesList() {
            const listContainer = document.getElementById('image-names-list');
            listContainer.innerHTML = '';
            
            if (imageNames.length === 0) {
                listContainer.innerHTML = '<p>暂无图片名称</p>';
                return;
            }
            
            const ul = document.createElement('ul');
            imageNames.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                ul.appendChild(li);
            });
            listContainer.appendChild(ul);
        }
        
        // 读取Excel文件
        function readExcelFile() {
            const fileInput = document.getElementById('excel-file');
            
            if (fileInput.files.length === 0) {
                alert('请先选择Excel文件');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                currentWorkbook = XLSX.read(data, { type: 'array' });
                
                // 获取第一个工作表
                currentSheetName = currentWorkbook.SheetNames[0];
                const worksheet = currentWorkbook.Sheets[currentSheetName];
                
                // 将工作表转换为JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // 显示Excel数据
                displayExcelData(jsonData);
                
                // 提示用户可以导出包含图片名称的Excel
                if (imageNames.length > 0) {
                    alert('图片名称已准备好，请点击"导出包含图片名称的Excel"按钮添加到第8行并导出');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 显示Excel数据
        function displayExcelData(data) {
            const container = document.getElementById('excel-data-container');
            
            if (data.length === 0) {
                container.innerHTML = '<p>Excel文件中没有数据</p>';
                return;
            }
            
            // 创建表格
            const table = document.createElement('table');
            
            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // 获取所有列名
            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 创建表格内容
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        // 导出包含图片名称的Excel文件
        function exportExcelWithImages() {
            if (!currentWorkbook || !currentSheetName) {
                alert('请先选择并读取一个Excel文件');
                return;
            }
            
            if (imageNames.length === 0) {
                alert('请先选择图片文件夹');
                return;
            }
            
            // 获取店铺分类名称输入框的值
            const storeCategoryInput = document.getElementById('store-category-input');
            const storeCategoryValue = storeCategoryInput ? storeCategoryInput.value.trim() : '';
            
            try {
                // 创建新的工作簿
                const newWorkbook = XLSX.utils.book_new();
                const originalWorksheet = currentWorkbook.Sheets[currentSheetName];
                
                // 深度复制原始工作表
                const newWorksheet = {};
                Object.keys(originalWorksheet).forEach(key => {
                    newWorksheet[key] = JSON.parse(JSON.stringify(originalWorksheet[key]));
                });
                
                // 转换为JSON以便操作
                let jsonData = XLSX.utils.sheet_to_json(originalWorksheet);
                
                // 饿了么列位置设置 - 根据用户要求设置列位置
                // A=商品条形码, B=商品名称, C=商品三级类目名称, D=重量, E=重量单位, F=产地, 
                // G=净含量, H=品种, I=包装规格, J=售价, K=库存, L=商品最低起购量, M=商品状态, 
                // N=店铺分类名称, O=商品自定义ID, P=货架号, Q=限购开始时间, R=限购结束时间, 
                // S=限购周期, T=限购周期内每人限购件数, U=包装费, V=七天无理由退换
                const columnPositions = {
                    barcode: 0,      // A列 - 商品条形码
                    productName: 1, // B列 - 商品名称
                    category: 2,    // C列 - 商品三级类目名称
                    weight: 3,      // D列 - 重量
                    unit: 4,        // E列 - 重量单位
                    origin: 5,      // F列 - 产地
                    netContent: 6,  // G列 - 净含量
                    variety: 7,     // H列 - 品种
                    packaging: 8,  // I列 - 包装规格
                    price: 9,       // J列 - 售价
                    stock: 10,      // K列 - 库存
                    minPurchase: 11, // L列 - 商品最低起购量
                    status: 12,     // M列 - 商品状态
                    shopCategory: 13, // N列 - 店铺分类名称
                    customId: 14,   // O列 - 商品自定义ID
                    shelfNumber: 15, // P列 - 货架号
                    limitStartTime: 16, // Q列 - 限购开始时间
                    limitEndTime: 17,   // R列 - 限购结束时间
                    limitCycle: 18,     // S列 - 限购周期
                    limitPerPerson: 19, // T列 - 限购周期内每人限购件数
                    packagingFee: 20,   // U列 - 包装费
                    returnPolicy: 21    // V列 - 七天无理由退换
                };
                
                // 从第8行开始添加（行索引从0开始，所以是7）
                let startRow = 2;
                
                // 处理每张图片，添加到相应列
                imageNames.forEach((imgName, index) => {
                    // 提取不包含后缀的图片名称
                    const nameWithoutExtension = imgName.substring(0, imgName.lastIndexOf('.')) || imgName;
                    
                    // 当前行号（行索引+1）
                    const currentRow = startRow + index + 1;
                    
                    // 使用饿了么列位置设置各列的值
                    
                    // 商品条形码 (A列)
                    const barcodeCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.barcode});
                    newWorksheet[barcodeCell] = { t: 's', v: '' };
                    
                    // 商品名称 (B列)
                    const productNameCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.productName});
                    newWorksheet[productNameCell] = { t: 's', v: nameWithoutExtension };
                    
                    // 商品三级类目名称 (C列)
                    const categoryCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.category});
                    newWorksheet[categoryCell] = { t: 's', v: '' };
                    
                    // 重量 (D列)
                    const weightCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.weight});
                    newWorksheet[weightCell] = { t: 'n', v: 500, w: '500' };
                    
                    // 重量单位 (E列)
                    const unitCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.unit});
                    newWorksheet[unitCell] = { t: 's', v: 'g', w: 'g' };
                    
                    // 产地 (F列)
                    const originCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.origin});
                    newWorksheet[originCell] = { t: 's', v: '' };
                    
                    // 净含量 (G列)
                    const netContentCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.netContent});
                    newWorksheet[netContentCell] = { t: 's', v: '' };
                    
                    // 品种 (H列)
                    const varietyCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.variety});
                    newWorksheet[varietyCell] = { t: 's', v: '' };
                    
                    // 包装规格 (I列)
                    const packagingCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.packaging});
                    newWorksheet[packagingCell] = { t: 's', v: '' };
                    
                    // 售价 (J列)
                    const priceCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.price});
                    newWorksheet[priceCell] = { t: 'n', v: 199.00 };
                    
                    // 库存 (K列)
                    const stockCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.stock});
                    newWorksheet[stockCell] = { t: 'n', v: 999 };
                    
                    // 商品最低起购量 (L列)
                    const minPurchaseCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.minPurchase});
                    newWorksheet[minPurchaseCell] = { t: 's', v: '' };
                    
                    // 商品状态 (M列)
                    const statusCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.status});
                    newWorksheet[statusCell] = { t: 's', v: '下架' };
                    
                    // 店铺分类名称 (N列) - 使用输入框的值
                    const shopCategoryCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.shopCategory});
                    newWorksheet[shopCategoryCell] = { t: 's', v: storeCategoryValue };
                    
                    // 商品自定义ID (O列)
                    const customIdCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.customId});
                    newWorksheet[customIdCell] = { t: 's', v: '' };
                    
                    // 货架号 (P列)
                    const shelfNumberCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.shelfNumber});
                    newWorksheet[shelfNumberCell] = { t: 's', v: '' };
                    
                    // 限购开始时间 (Q列)
                    const limitStartTimeCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.limitStartTime});
                    newWorksheet[limitStartTimeCell] = { t: 's', v: '' };
                    
                    // 限购结束时间 (R列)
                    const limitEndTimeCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.limitEndTime});
                    newWorksheet[limitEndTimeCell] = { t: 's', v: '' };
                    
                    // 限购周期 (S列)
                    const limitCycleCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.limitCycle});
                    newWorksheet[limitCycleCell] = { t: 's', v: '' };
                    
                    // 限购周期内每人限购件数 (T列)
                    const limitPerPersonCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.limitPerPerson});
                    newWorksheet[limitPerPersonCell] = { t: 's', v: '' };
                    
                    // 包装费 (U列)
                    const packagingFeeCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.packagingFee});
                    newWorksheet[packagingFeeCell] = { t: 's', v: '' };
                    
                    // 七天无理由退换 (V列)
                    const returnPolicyCell = XLSX.utils.encode_cell({r: currentRow - 1, c: columnPositions.returnPolicy});
                    newWorksheet[returnPolicyCell] = { t: 's', v: '' };
                });
                
                // 更新工作表范围以包含新添加的行
                const originalRange = XLSX.utils.decode_range(newWorksheet['!ref'] || 'A1:A1');
                const lastDataRow = startRow + imageNames.length;
                
                // 确保新范围包含所有新添加的数据，扩展到V列(第21列索引)
                const newRange = {
                    s: { r: 0, c: 0 }, // 起始行列
                    e: { r: Math.max(originalRange.e.r, lastDataRow), c: Math.max(originalRange.e.c, 21) } // 结束行列，确保包含到V列
                };
                
                newWorksheet['!ref'] = XLSX.utils.encode_range(newRange);
                
                // 将工作表添加到工作簿
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, currentSheetName);
                
                // 导出Excel文件
                const fileName = '饿了么批量新建_' + new Date().getTime() + '.xlsx';
                XLSX.writeFile(newWorkbook, fileName);
                
            } catch (error) {
                console.error('导出Excel文件失败:', error);
                alert('导出Excel文件失败，请查看控制台获取详细信息');
            }
        }

        // 使用XMLHttpRequest自动读取Excel文件
        async function autoReadExcelFile() {
            try {
                // 使用fetch API读取本地文件
                const response = await fetch('src/ele.xlsx');
                
                if (!response.ok) {
                    throw new Error('无法加载Excel文件，状态码: ' + response.status);
                }
                
                // 以ArrayBuffer形式获取文件内容
                const arrayBuffer = await response.arrayBuffer();
                
                // 将ArrayBuffer转换为Buffer
                const buffer = new Uint8Array(arrayBuffer);
                
                // 读取Excel文件
                currentWorkbook = XLSX.read(buffer, { type: 'array' });
                
                // 获取第一个工作表
                currentSheetName = currentWorkbook.SheetNames[0];
                const worksheet = currentWorkbook.Sheets[currentSheetName];
                
                // 将工作表转换为JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // 显示Excel数据
                displayExcelData(jsonData);
                
                // 更新文件输入框显示
                const fileInput = document.getElementById('excel-file');
                const fileInfo = document.createElement('div');
                fileInfo.style.marginTop = '10px';
                fileInfo.style.color = '#4CAF50';
                fileInfo.innerHTML = '<strong>已自动加载:</strong> src/ele.xlsx';
                fileInput.parentNode.appendChild(fileInfo);
                
            } catch (error) {
                // 如果fetch失败，尝试显示友好的提示
                if (error.message.includes('无法加载')) {
                    alert('无法自动加载Excel文件。请尝试手动选择文件。\n原因: ' + error.message);
                } else {
                    alert('自动读取Excel文件失败。请手动选择文件。');
                }
            }
        }

    </script>
</body>
</html>